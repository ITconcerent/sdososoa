
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управління товарами - iStore Admin</title>
    <link rel="stylesheet" href="admin-products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Додаткові стилі для управління користувачами */
        .users-section {
            display: none;
        }
        
        .users-section.active {
            display: block;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .users-table th,
        .users-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }
        
        .users-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        .user-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-blocked {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-admin {
            background: #cce7ff;
            color: #004085;
        }
        
        .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .user-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .user-btn.block {
            background: #e53935;
            color: white;
        }
        
        .user-btn.unblock {
            background: #4CAF50;
            color: white;
        }
        
        .user-btn.admin {
            background: #007aff;
            color: white;
        }
        
        .user-btn.history {
            background: #ffa000;
            color: white;
        }
        
        .user-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .empty-users {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-users i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .admin-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .admin-tab.active {
            border-bottom-color: #007aff;
            color: #007aff;
        }

        /* Стилі для чату підтримки */
        .support-chat-section {
            display: none;
        }
        
        .support-chat-section.active {
            display: block;
        }
        
        .support-chat-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: 600px;
        }
        
        .chat-users-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .chat-user-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e1e1;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .chat-user-item:hover {
            background: #f8f9fa;
        }
        
        .chat-user-item.active {
            background: #007aff;
            color: white;
        }
        
        .chat-user-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .chat-user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .chat-user-last-message {
            font-size: 12px;
            color: #666;
            opacity: 0.8;
            line-height: 1.3;
        }
        
        .chat-user-item.active .chat-user-last-message {
            color: white;
        }
        
        .chat-user-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .chat-user-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
        }
        
        .chat-user-item.active .chat-user-time {
            color: white;
        }
        
        .unread-badge {
            background: #e53935;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        
        .admin-chat-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .admin-chat-header {
            padding: 20px;
            border-bottom: 1px solid #e1e1e1;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            min-height: 80px;
            display: flex;
            align-items: center;
        }
        
        .selected-chat-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .selected-chat-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .admin-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
        }
        
        .admin-message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.4;
        }
        
        .admin-message.user {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #e1e1e1;
            border-bottom-left-radius: 5px;
        }
        
        .admin-message.agent {
            align-self: flex-end;
            background: #007aff;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .admin-message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .admin-message.user .admin-message-time {
            text-align: left;
        }
        
        .admin-message.agent .admin-message-time {
            text-align: right;
        }
        
        .admin-chat-input-container {
            padding: 20px;
            border-top: 1px solid #e1e1e1;
        }
        
        .admin-chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .admin-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e1e1;
            border-radius: 25px;
            resize: none;
            font-size: 14px;
            transition: border-color 0.3s;
            max-height: 120px;
            min-height: 50px;
            font-family: inherit;
        }
        
        .admin-chat-input:focus {
            border-color: #007aff;
            outline: none;
        }
        
        .admin-send-btn {
            background: #007aff;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .admin-send-btn:hover {
            background: #0056cc;
            transform: scale(1.05);
        }
        
        .admin-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .no-chat-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            color: #666;
            text-align: center;
            padding: 40px;
        }
        
        .no-chat-selected i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .no-chat-selected h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        
        .no-chat-selected p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Адаптивність для чату */
        @media (max-width: 1024px) {
            .support-chat-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .chat-users-list {
                max-height: 250px;
            }
            
            .admin-chat-container {
                height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .support-chat-layout {
                gap: 15px;
            }
            
            .admin-message {
                max-width: 85%;
            }
            
            .chat-user-item {
                padding: 12px 15px;
            }
        }
        
        @media (max-width: 480px) {
            .admin-message {
                max-width: 90%;
                padding: 10px 14px;
            }
            
            .admin-chat-messages {
                padding: 15px;
            }
            
            .admin-chat-input-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="products-admin-container">
        <!-- Header -->
        <header class="products-header">
            <div class="header-left">
                <h1>📦 Управління товарами</h1>
                <span class="products-count" id="products-count">0 товарів</span>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Додати товар
                </button>
                <button class="btn btn-secondary" onclick="exportProducts()">
                    <i class="fas fa-download"></i>
                    Експорт
                </button>
                <button class="btn btn-success" onclick="syncWithMainSite()">
                    <i class="fas fa-sync"></i>
                    Синхронізувати
                </button>
            </div>
        </header>

        <!-- Admin Tabs -->
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchAdminTab('products')">Товари</div>
            <div class="admin-tab" onclick="switchAdminTab('users')">Користувачі</div>
            <div class="admin-tab" onclick="switchAdminTab('support-chat')">Чат підтримки</div>
        </div>

        <!-- Products Section -->
        <div class="products-section active" id="products-section">
            <!-- Filters -->
            <div class="products-filters">
                <div class="filter-group">
                    <input type="text" id="search-products" placeholder="🔍 Пошук товарів..." oninput="filterProducts()">
                </div>
                <div class="filter-group">
                    <select id="category-filter" onchange="filterProducts()">
                        <option value="">Всі категорії</option>
                        <option value="iphone">iPhone</option>
                        <option value="ipad">iPad</option>
                        <option value="macbook">MacBook</option>
                        <option value="apple-watch">Apple Watch</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="status-filter" onchange="filterProducts()">
                        <option value="">Всі статуси</option>
                        <option value="in-stock">В наявності</option>
                        <option value="out-of-stock">Немає в наявності</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="products-grid">
                <!-- Товари будуть додаватись тут -->
            </div>
        </div>

        <!-- Users Section -->
        <div class="users-section" id="users-section">
            <div class="products-filters">
                <div class="filter-group">
                    <input type="text" id="search-users" placeholder="🔍 Пошук користувачів..." oninput="filterUsers()">
                </div>
                <div class="filter-group">
                    <select id="status-users-filter" onchange="filterUsers()">
                        <option value="">Всі статуси</option>
                        <option value="active">Активні</option>
                        <option value="blocked">Заблоковані</option>
                        <option value="admin">Адміністратори</option>
                    </select>
                </div>
            </div>

            <div class="users-container">
                <table class="users-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ім'я</th>
                            <th>Email</th>
                            <th>Телефон</th>
                            <th>Статус</th>
                            <th>Дата реєстрації</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Користувачі будуть додані тут -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Support Chat Section -->
        <div class="support-chat-section" id="support-chat-section">
            <div class="support-chat-layout">
                <div class="chat-users-list" id="chat-users-list">
                    <!-- Список користувачів з активними чатами -->
                </div>
                
                <div class="admin-chat-container">
                    <div class="admin-chat-header" id="admin-chat-header">
                        <div class="no-chat-selected" id="no-chat-selected">
                            <i class="fas fa-comments"></i>
                            <h3>Оберіть чат для перегляду</h3>
                            <p>Виберіть користувача зі списку, щоб переглянути та відповісти на повідомлення</p>
                        </div>
                        <div class="selected-chat-info" id="selected-chat-info" style="display: none;">
                            <h3 id="selected-user-name">Користувач</h3>
                            <p id="selected-user-status">Онлайн</p>
                        </div>
                    </div>
                    
                    <div class="admin-chat-messages" id="admin-chat-messages">
                        <!-- Повідомлення будуть додаватись тут -->
                    </div>
                    
                    <div class="admin-chat-input-container" id="admin-chat-input-container" style="display: none;">
                        <div class="admin-chat-input-wrapper">
                            <textarea 
                                class="admin-chat-input" 
                                id="admin-message-input" 
                                placeholder="Введіть вашу відповідь..."
                                rows="1"
                            ></textarea>
                            <button class="admin-send-btn" id="admin-send-btn" onclick="sendAdminMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Product Modal -->
        <div class="modal" id="product-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Додати товар</h2>
                    <button class="close-btn" onclick="closeProductModal()">&times;</button>
                </div>
                
                <form id="product-form" onsubmit="saveProduct(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-name">Назва товару *</label>
                            <input type="text" id="product-name" required>
                        </div>
                        <div class="form-group">
                            <label for="product-model">Модель *</label>
                            <input type="text" id="product-model" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-category">Категорія *</label>
                            <select id="product-category" required>
                                <option value="">Оберіть категорію</option>
                                <option value="iphone">iPhone</option>
                                <option value="ipad">iPad</option>
                                <option value="macbook">MacBook</option>
                                <option value="apple-watch">Apple Watch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-price">Ціна (₴) *</label>
                            <input type="number" id="product-price" min="0" step="1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-specs">Характеристики</label>
                        <input type="text" id="product-specs" placeholder="Наприклад: 6.1'' Super Retina XDR">
                    </div>

                    <div class="form-group">
                        <label for="product-description">Опис</label>
                        <textarea id="product-description" rows="3" placeholder="Детальний опис товару..."></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div class="form-group">
                        <label>Зображення товару</label>
                        <div class="image-upload-container">
                            <div class="image-previews" id="image-previews">
                                <div class="image-preview-placeholder">
                                    <i class="fas fa-images"></i>
                                    <span>Додайте фото товару</span>
                                </div>
                            </div>
                            <div class="upload-controls">
                                <input type="file" id="product-images" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('product-images').click()">
                                    <i class="fas fa-plus"></i>
                                    Додати фото
                                </button>
                                <button type="button" class="btn btn-outline" onclick="clearAllImages()">
                                    <i class="fas fa-trash"></i>
                                    Видалити всі
                                </button>
                            </div>
                            <div class="upload-info">
                                <small>Можна завантажити до 5 фото. Перше фото буде основним.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Characteristics -->
                    <div class="form-group">
                        <label>Додаткові характеристики</label>
                        <div id="characteristics-container">
                            <!-- Characteristics will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline" onclick="addCharacteristic()">
                            <i class="fas fa-plus"></i>
                            Додати характеристику
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Скасувати</button>
                        <button type="submit" class="btn btn-primary" id="save-product-btn">Зберегти товар</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal" id="delete-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Видалити товар</h2>
                </div>
                <p>Ви впевнені, що хочете видалити цей товар? Цю дію неможливо скасувати.</p>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Скасувати</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Видалити</button>
                </div>
            </div>
        </div>

        <!-- User History Modal -->
        <div class="modal" id="user-history-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Історія замовлень користувача</h2>
                    <button class="close-btn" onclick="closeUserHistoryModal()">&times;</button>
                </div>
                <div class="user-history-content" id="user-history-content">
                    <!-- Історія замовлень буде додана тут -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Глобальні змінні
        let products = JSON.parse(localStorage.getItem('adminProducts')) || [];
        let currentEditingId = null;
        let productToDelete = null;
        let productImages = [];
        let currentEditingUser = null;
        let currentChatUser = null;
        let supportChatInterval = null;

        // Broadcast Channel для синхронізації
        const broadcastChannel = new BroadcastChannel('products_updates');
        const supportChannel = new BroadcastChannel('support_messages');

        // Ініціалізація
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Ініціалізація модуля товарів...');
            loadProducts();
            loadUsers();
            loadSupportChats();
            updateProductsCount();
            setupBroadcastListener();
            autoSyncOnLoad();
            startSupportPolling();
            
            // Ініціалізація полів чату
            initializeChatFields();
        });

        // Ініціалізація полів введення чату
        function initializeChatFields() {
            const adminMessageInput = document.getElementById('admin-message-input');
            if (adminMessageInput) {
                adminMessageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                adminMessageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAdminMessage();
                    }
                });
            }
        }

        // Налаштування слухача оновлень
        function setupBroadcastListener() {
            broadcastChannel.onmessage = (event) => {
                if (event.data.type === 'products_updated') {
                    console.log('Отримано оновлення товарів');
                    loadProducts();
                    updateProductsCount();
                }
            };
            
            supportChannel.onmessage = (event) => {
                if (event.data.type === 'messages_updated') {
                    console.log('Отримано оновлення повідомлень підтримки');
                    loadSupportChats();
                    if (currentChatUser) {
                        loadChatMessages(currentChatUser);
                    }
                }
            };
        }

        // Перемикання між вкладками
        function switchAdminTab(tab) {
            // Оновлюємо активні вкладки
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.products-section, .users-section, .support-chat-section').forEach(s => s.classList.remove('active'));
            
            // Активуємо обрану вкладку
            const tabIndex = {'products': 1, 'users': 2, 'support-chat': 3}[tab];
            const tabElement = document.querySelector(`.admin-tab:nth-child(${tabIndex})`);
            const sectionElement = document.getElementById(`${tab}-section`);
            
            if (tabElement) tabElement.classList.add('active');
            if (sectionElement) sectionElement.classList.add('active');
        }

        // ========== СИСТЕМА ЧАТУ ПІДТРИМКИ ==========

        // Завантаження списку чатів
        function loadSupportChats() {
            const chatUsersList = document.getElementById('chat-users-list');
            const allMessages = getAllSupportMessages();
            
            // Отримуємо унікальних користувачів
            const uniqueUsers = {};
            allMessages.forEach(msg => {
                if (!uniqueUsers[msg.userId]) {
                    uniqueUsers[msg.userId] = {
                        userId: msg.userId,
                        lastMessage: msg.text,
                        lastMessageTime: msg.timestamp,
                        unread: countUnreadMessages(msg.userId)
                    };
                } else {
                    // Оновлюємо останнє повідомлення, якщо воно новіше
                    if (new Date(msg.timestamp) > new Date(uniqueUsers[msg.userId].lastMessageTime)) {
                        uniqueUsers[msg.userId].lastMessage = msg.text;
                        uniqueUsers[msg.userId].lastMessageTime = msg.timestamp;
                    }
                }
            });
            
            const usersArray = Object.values(uniqueUsers);
            
            if (usersArray.length === 0) {
                chatUsersList.innerHTML = `
                    <div class="empty-users">
                        <i class="fas fa-comments"></i>
                        <h3>Чатів немає</h3>
                        <p>Користувачі ще не зверталися до підтримки</p>
                    </div>
                `;
                return;
            }
            
            // Сортуємо за часом останнього повідомлення
            usersArray.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            
            chatUsersList.innerHTML = usersArray.map(user => `
                <div class="chat-user-item ${currentChatUser === user.userId ? 'active' : ''}" onclick="selectChatUser('${user.userId}')">
                    <div class="chat-user-info">
                        <div class="chat-user-name">Користувач ${user.userId.substring(5)}</div>
                        <div class="chat-user-last-message">${user.lastMessage.length > 50 ? user.lastMessage.substring(0, 50) + '...' : user.lastMessage}</div>
                    </div>
                    <div class="chat-user-meta">
                        <div class="chat-user-time">${formatMessageTime(user.lastMessageTime)}</div>
                        ${user.unread > 0 ? `<div class="unread-badge">${user.unread}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Отримати всі повідомлення підтримки
        function getAllSupportMessages() {
            return JSON.parse(localStorage.getItem('supportMessages')) || [];
        }

        // Отримати повідомлення для конкретного користувача
        function getUserSupportMessages(userId) {
            const allMessages = getAllSupportMessages();
            return allMessages.filter(msg => msg.userId === userId);
        }

        // Підрахувати непрочитані повідомлення
        function countUnreadMessages(userId) {
            const userMessages = getUserSupportMessages(userId);
            return userMessages.filter(msg => msg.type === 'user' && !msg.read).length;
        }

        // Вибір користувача для чату
        function selectChatUser(userId) {
            currentChatUser = userId;
            loadSupportChats();
            loadChatMessages(userId);
            
            // Позначаємо повідомлення як прочитані
            markMessagesAsRead(userId);
        }

        // Завантаження повідомлень чату
        function loadChatMessages(userId) {
            const adminChatMessages = document.getElementById('admin-chat-messages');
            const userMessages = getUserSupportMessages(userId);
            
            adminChatMessages.innerHTML = '';
            
            userMessages.forEach(msg => {
                addAdminMessageToChat(msg.text, msg.type, msg.timestamp, false);
            });
            
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
            
            // Показуємо інформацію про вибраного користувача
            document.getElementById('no-chat-selected').style.display = 'none';
            document.getElementById('selected-chat-info').style.display = 'block';
            document.getElementById('admin-chat-input-container').style.display = 'block';
            
            document.getElementById('selected-user-name').textContent = `Користувач ${userId.substring(5)}`;
        }

        // Додати повідомлення в адмін-чат
        function addAdminMessageToChat(text, sender, timestamp, animate = true) {
            const adminChatMessages = document.getElementById('admin-chat-messages');
            const messageDiv = document.createElement('div');
            
            const messageTime = new Date(timestamp);
            const timeString = messageTime.getHours().toString().padStart(2, '0') + ':' + 
                             messageTime.getMinutes().toString().padStart(2, '0');
            
            messageDiv.className = `admin-message ${sender}`;
            if (animate) {
                messageDiv.style.animation = 'fadeIn 0.3s ease-out';
            }
            
            messageDiv.innerHTML = `
                <div class="admin-message-text">${text}</div>
                <div class="admin-message-time">${timeString}</div>
            `;
            
            adminChatMessages.appendChild(messageDiv);
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        }

        // Відправити повідомлення від адміна
        function sendAdminMessage() {
            if (!currentChatUser) {
                showNotification('Оберіть користувача для відповіді', 'error');
                return;
            }
            
            const messageInput = document.getElementById('admin-message-input');
            const messageText = messageInput.value.trim();
            
            if (messageText === '') {
                showNotification('Будь ласка, введіть повідомлення', 'error');
                return;
            }
            
            // Створюємо повідомлення
            const message = {
                id: 'msg_' + Date.now(),
                userId: currentChatUser,
                text: messageText,
                type: 'agent',
                timestamp: new Date().toISOString(),
                read: true
            };
            
            // Зберігаємо та відображаємо
            saveSupportMessage(message);
            addAdminMessageToChat(messageText, 'agent', message.timestamp, true);
            
            // Очищаємо поле введення
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Синхронізуємо з користувачем
            broadcastSupportUpdate();
            
            showNotification('Повідомлення відправлено', 'success');
        }

        // Зберегти повідомлення підтримки
        function saveSupportMessage(message) {
            const allMessages = getAllSupportMessages();
            allMessages.push(message);
            localStorage.setItem('supportMessages', JSON.stringify(allMessages));
        }

        // Позначити повідомлення як прочитані
        function markMessagesAsRead(userId) {
            const allMessages = getAllSupportMessages();
            let updated = false;
            
            allMessages.forEach(msg => {
                if (msg.userId === userId && msg.type === 'user' && !msg.read) {
                    msg.read = true;
                    updated = true;
                }
            });
            
            if (updated) {
                localStorage.setItem('supportMessages', JSON.stringify(allMessages));
                loadSupportChats();
            }
        }

        // Форматування часу повідомлення
        function formatMessageTime(timestamp) {
            const messageTime = new Date(timestamp);
            const now = new Date();
            const diffMs = now - messageTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'щойно';
            if (diffMins < 60) return `${diffMins} хв`;
            if (diffHours < 24) return `${diffHours} год`;
            if (diffDays < 7) return `${diffDays} дн`;
            
            return messageTime.toLocaleDateString('uk-UA');
        }

        // Синхронізація оновлень
        function broadcastSupportUpdate() {
            localStorage.setItem('supportLastUpdate', Date.now().toString());
            
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('support_messages');
                channel.postMessage({
                    type: 'messages_updated',
                    timestamp: Date.now()
                });
            }
        }

        // Опитування для оновлення чату
        function startSupportPolling() {
            supportChatInterval = setInterval(() => {
                const lastUpdate = localStorage.getItem('supportLastUpdate');
                const currentUpdate = localStorage.getItem('currentAdminSupportUpdate');
                
                if (lastUpdate !== currentUpdate) {
                    loadSupportChats();
                    if (currentChatUser) {
                        loadChatMessages(currentChatUser);
                    }
                    localStorage.setItem('currentAdminSupportUpdate', lastUpdate);
                }
            }, 2000);
        }

        // ========== УПРАВЛІННЯ КОРИСТУВАЧАМИ ==========

        // Завантаження користувачів
        function loadUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            
            if (usersDatabase.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-users">
                            <i class="fas fa-users"></i>
                            <h3>Користувачів не знайдено</h3>
                            <p>Користувачі з'являться після реєстрації на сайті</p>
                        </td>
                    </tr>
                `;
                return;
            }

            usersTableBody.innerHTML = usersDatabase.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'Не вказано'}</td>
                    <td>
                        <span class="user-status ${getUserStatusClass(user)}">
                            ${getUserStatusText(user)}
                        </span>
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString('uk-UA')}</td>
                    <td class="user-actions">
                        ${user.isBlocked ? 
                            `<button class="user-btn unblock" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-unlock"></i> Розблокувати
                            </button>` :
                            `<button class="user-btn block" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-ban"></i> Заблокувати
                            </button>`
                        }
                        ${!user.isAdmin ? 
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})">
                                <i class="fas fa-crown"></i> Зробити адміном
                            </button>` :
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})" style="background: #6c757d;">
                                <i class="fas fa-user"></i> Забрати права
                            </button>`
                        }
                        <button class="user-btn history" onclick="showUserHistory(${user.id})">
                            <i class="fas fa-history"></i> Історія
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Отримання класу статусу користувача
        function getUserStatusClass(user) {
            if (user.isBlocked) return 'status-blocked';
            if (user.isAdmin) return 'status-admin';
            return 'status-active';
        }

        // Отримання тексту статусу користувача
        function getUserStatusText(user) {
            if (user.isBlocked) return 'Заблокований';
            if (user.isAdmin) return 'Адміністратор';
            return 'Активний';
        }

        // Блокування/розблокування користувача
        function toggleUserBlock(userId) {
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            const userIndex = usersDatabase.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                usersDatabase[userIndex].isBlocked = !usersDatabase[userIndex].isBlocked;
                localStorage.setItem('storeUsers', JSON.stringify(usersDatabase));
                
                // Оновлюємо поточного користувача, якщо це він
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser && currentUser.id === userId) {
                    currentUser.isBlocked = usersDatabase[userIndex].isBlocked;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                loadUsers();
                showNotification(usersDatabase[userIndex].isBlocked ? 
                    '✅ Користувача заблоковано' : '✅ Користувача розблоковано', 'success');
            }
        }

        // Зміна статусу адміністратора
        function toggleAdminStatus(userId) {
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            const userIndex = usersDatabase.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                usersDatabase[userIndex].isAdmin = !usersDatabase[userIndex].isAdmin;
                localStorage.setItem('storeUsers', JSON.stringify(usersDatabase));
                
                // Оновлюємо поточного користувача, якщо це він
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser && currentUser.id === userId) {
                    currentUser.isAdmin = usersDatabase[userIndex].isAdmin;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                loadUsers();
                showNotification(usersDatabase[userIndex].isAdmin ? 
                    '✅ Права адміна надано' : '✅ Права адміна забрано', 'success');
            }
        }

        // Показати історію замовлень користувача
        function showUserHistory(userId) {
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            const user = usersDatabase.find(u => u.id === userId);
            
            if (!user) return;

            const historyContent = document.getElementById('user-history-content');
            const orders = user.orders || [];

            if (orders.length === 0) {
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-shopping-bag" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>Замовлень немає</h3>
                        <p>Користувач ще не робив замовлень</p>
                    </div>
                `;
            } else {
                historyContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>Користувач: ${user.name}</h3>
                        <p>Email: ${user.email}</p>
                        <p>Всього замовлень: ${orders.length}</p>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${orders.map(order => `
                            <div style="border: 1px solid #e1e1e1; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong>Замовлення #${order.id}</strong>
                                    <span style="color: #e53935; font-weight: bold;">${order.total ? order.total.toLocaleString('uk-UA') + ' ₴' : 'Ціна не вказана'}</span>
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    <div>Дата: ${new Date(order.date).toLocaleDateString('uk-UA')}</div>
                                    <div>Статус: ${order.status === 'completed' ? '✅ Виконано' : '⏳ В обробці'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            document.getElementById('user-history-modal').classList.add('active');
        }

        // Закриття модалки історії
        function closeUserHistoryModal() {
            document.getElementById('user-history-modal').classList.remove('active');
        }

        // Фільтрація користувачів
        function filterUsers() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            const statusFilter = document.getElementById('status-users-filter').value;
            
            const usersTableBody = document.getElementById('users-table-body');
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            
            const filteredUsers = usersDatabase.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                    user.email.toLowerCase().includes(searchTerm);
                
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = !user.isBlocked && !user.isAdmin;
                } else if (statusFilter === 'blocked') {
                    matchesStatus = user.isBlocked;
                } else if (statusFilter === 'admin') {
                    matchesStatus = user.isAdmin;
                }
                
                return matchesSearch && matchesStatus;
            });

            if (filteredUsers.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px 20px; color: #666;">
                            <i class="fas fa-search"></i>
                            <p>Користувачів не знайдено</p>
                        </td>
                    </tr>
                `;
                return;
            }

            usersTableBody.innerHTML = filteredUsers.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'Не вказано'}</td>
                    <td>
                        <span class="user-status ${getUserStatusClass(user)}">
                            ${getUserStatusText(user)}
                        </span>
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString('uk-UA')}</td>
                    <td class="user-actions">
                        ${user.isBlocked ? 
                            `<button class="user-btn unblock" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-unlock"></i> Розблокувати
                            </button>` :
                            `<button class="user-btn block" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-ban"></i> Заблокувати
                            </button>`
                        }
                        ${!user.isAdmin ? 
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})">
                                <i class="fas fa-crown"></i> Зробити адміном
                            </button>` :
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})" style="background: #6c757d;">
                                <i class="fas fa-user"></i> Забрати права
                            </button>`
                        }
                        <button class="user-btn history" onclick="showUserHistory(${user.id})">
                            <i class="fas fa-history"></i> Історія
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Функція для сповіщень
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#e53935' : '#007aff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // ========== ФУНКЦІЇ ДЛЯ ТОВАРІВ (без змін) ==========
        
        // Завантаження товарів
        function loadProducts() {
            const productsGrid = document.getElementById('products-grid');
            
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📦</div>
                        <h3 style="margin-bottom: 10px; color: #333;">Немає товарів</h3>
                        <p style="margin-bottom: 25px; color: #666;">Додайте перший товар до вашого магазину</p>
                        <button class="btn btn-primary" onclick="openAddProductModal()">
                            <i class="fas fa-plus"></i>
                            Додати товар
                        </button>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = products.map(product => `
                <div class="product-card" data-category="${product.category}" data-status="${product.status || 'in-stock'}">
                    <div class="product-image">
                        ${product.mainImage || product.image ? 
                            `<img src="${product.mainImage || product.image}" alt="${product.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"> 
                             <div class="placeholder" style="display: none;"><i class="fas fa-image"></i></div>` :
                            `<div class="placeholder"><i class="fas fa-image"></i></div>`
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-model">${product.model}</div>
                        <h3>${product.name}</h3>
                        <div class="product-specs">${product.specs || ''}</div>
                        <div class="product-price">${formatPrice(product.price)} ₴</div>
                        <div class="product-status" style="font-size: 12px; color: ${product.status === 'out-of-stock' ? '#e53935' : '#4CAF50'}; margin-bottom: 10px;">
                            ${product.status === 'out-of-stock' ? '❌ Немає в наявності' : '✅ В наявності'}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-outline" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                                Редагувати
                            </button>
                            <button class="btn btn-danger" onclick="openDeleteModal(${product.id})">
                                <i class="fas fa-trash"></i>
                                Видалити
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Форматування ціни
        function formatPrice(price) {
            return parseInt(price).toLocaleString('uk-UA');
        }

        // Оновлення лічильника товарів
        function updateProductsCount() {
            const countElement = document.getElementById('products-count');
            countElement.textContent = `${products.length} товар${products.length % 10 === 1 ? '' : 'и'}`;
        }

        // Фільтрація товарів
        function filterProducts() {
            const searchTerm = document.getElementById('search-products').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const productName = card.querySelector('h3').textContent.toLowerCase();
                const productCategory = card.getAttribute('data-category');
                const productStatus = card.getAttribute('data-status');
                
                const matchesSearch = productName.includes(searchTerm);
                const matchesCategory = !categoryFilter || productCategory === categoryFilter;
                const matchesStatus = !statusFilter || productStatus === statusFilter;
                
                card.style.display = (matchesSearch && matchesCategory && matchesStatus) ? 'block' : 'none';
            });
        }

        // Відкриття модалки додавання товару
        function openAddProductModal() {
            currentEditingId = null;
            productImages = [];
            document.getElementById('modal-title').textContent = 'Додати товар';
            document.getElementById('product-form').reset();
            updateImagePreviews();
            document.getElementById('characteristics-container').innerHTML = '';
            document.getElementById('product-modal').classList.add('active');
        }

        // Закриття модалки товару
        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        // Обробка завантаження кількох фото
        function handleImageUpload(event) {
            const files = event.target.files;
            const previewsContainer = document.getElementById('image-previews');
            
            const placeholder = previewsContainer.querySelector('.image-preview-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            for (let i = 0; i < files.length; i++) {
                if (productImages.length >= 5) {
                    alert('Максимально можна завантажити 5 фото');
                    break;
                }
                
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imageData = {
                        id: Date.now() + i,
                        data: e.target.result,
                        isMain: productImages.length === 0
                    };
                    
                    productImages.push(imageData);
                    updateImagePreviews();
                };
                
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }

        // Оновлення відображення прев'ю фото
        function updateImagePreviews() {
            const previewsContainer = document.getElementById('image-previews');
            previewsContainer.innerHTML = '';
            
            if (productImages.length === 0) {
                previewsContainer.innerHTML = `
                    <div class="image-preview-placeholder">
                        <i class="fas fa-images"></i>
                        <span>Додайте фото товару</span>
                    </div>
                `;
                return;
            }
            
            productImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = `image-preview-item ${image.isMain ? 'main-image' : ''}`;
                previewItem.innerHTML = `
                    <img src="${image.data}" alt="Preview ${index + 1}">
                    ${image.isMain ? '<div class="main-badge">Головне</div>' : ''}
                    <div class="image-actions">
                        <button class="image-action-btn" onclick="setAsMainImage(${image.id})" title="Зробити головним">
                            <i class="fas fa-star"></i>
                        </button>
                        <button class="image-action-btn" onclick="removeImage(${image.id})" title="Видалити">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                previewsContainer.appendChild(previewItem);
            });
        }

        // Встановити фото як головне
        function setAsMainImage(imageId) {
            productImages.forEach(image => {
                image.isMain = image.id === imageId;
            });
            updateImagePreviews();
        }

        // Видалити фото
        function removeImage(imageId) {
            const imageIndex = productImages.findIndex(img => img.id === imageId);
            const isMain = productImages[imageIndex].isMain;
            
            productImages.splice(imageIndex, 1);
            
            if (isMain && productImages.length > 0) {
                productImages[0].isMain = true;
            }
            
            updateImagePreviews();
        }

        // Очистити всі фото
        function clearAllImages() {
            productImages = [];
            updateImagePreviews();
        }

        // Додавання характеристики
        function addCharacteristic() {
            const container = document.getElementById('characteristics-container');
            const index = container.children.length;
            
            const characteristicRow = document.createElement('div');
            characteristicRow.className = 'characteristic-row';
            characteristicRow.innerHTML = `
                <input type="text" placeholder="Назва характеристики (напр. Процесор)" name="characteristic-key-${index}">
                <input type="text" placeholder="Значення (напр. A15 Bionic)" name="characteristic-value-${index}">
                <button type="button" class="remove-characteristic" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(characteristicRow);
        }

        // Збереження товару
        function saveProduct(event) {
            event.preventDefault();
            
            const formData = {
                id: currentEditingId || Date.now(),
                name: document.getElementById('product-name').value,
                model: document.getElementById('product-model').value,
                category: document.getElementById('product-category').value,
                price: parseInt(document.getElementById('product-price').value),
                specs: document.getElementById('product-specs').value,
                description: document.getElementById('product-description').value,
                status: 'in-stock',
                createdAt: new Date().toISOString(),
                lastUpdated: Date.now()
            };
            
            formData.images = productImages.map(img => img.data);
            formData.mainImage = productImages.find(img => img.isMain)?.data || '';
            
            finalizeSave(formData);
        }

        function finalizeSave(formData) {
            const characteristics = {};
            const characteristicRows = document.querySelectorAll('.characteristic-row');
            
            characteristicRows.forEach(row => {
                const keyInput = row.querySelector('input[name^="characteristic-key"]');
                const valueInput = row.querySelector('input[name^="characteristic-value"]');
                
                if (keyInput.value && valueInput.value) {
                    characteristics[keyInput.value] = valueInput.value;
                }
            });
            
            if (Object.keys(characteristics).length > 0) {
                formData.characteristics = characteristics;
            }
            
            if (currentEditingId) {
                const index = products.findIndex(p => p.id === currentEditingId);
                if (index !== -1) {
                    products[index] = { ...products[index], ...formData };
                }
            } else {
                products.push(formData);
            }
            
            localStorage.setItem('adminProducts', JSON.stringify(products));
            
            // АВТОМАТИЧНА СИНХРОНІЗАЦІЯ
            syncWithMainSite();
            
            loadProducts();
            updateProductsCount();
            closeProductModal();
            
            alert(currentEditingId ? 'Товар успішно оновлено!' : 'Товар успішно додано!');
        }

        // Редагування товару
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            currentEditingId = productId;
            document.getElementById('modal-title').textContent = 'Редагувати товар';
            
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-model').value = product.model;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-specs').value = product.specs || '';
            document.getElementById('product-description').value = product.description || '';
            
            productImages = [];
            if (product.images && product.images.length > 0) {
                product.images.forEach((imageData, index) => {
                    productImages.push({
                        id: Date.now() + index,
                        data: imageData,
                        isMain: index === 0 || imageData === product.mainImage
                    });
                });
            } else if (product.image) {
                productImages.push({
                    id: Date.now(),
                    data: product.image,
                    isMain: true
                });
            }
            updateImagePreviews();
            
            const container = document.getElementById('characteristics-container');
            container.innerHTML = '';
            
            if (product.characteristics) {
                Object.entries(product.characteristics).forEach(([key, value], index) => {
                    const characteristicRow = document.createElement('div');
                    characteristicRow.className = 'characteristic-row';
                    characteristicRow.innerHTML = `
                        <input type="text" placeholder="Назва характеристики" name="characteristic-key-${index}" value="${key}">
                        <input type="text" placeholder="Значення" name="characteristic-value-${index}" value="${value}">
                        <button type="button" class="remove-characteristic" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(characteristicRow);
                });
            }
            
            document.getElementById('product-modal').classList.add('active');
        }

        // Відкриття модалки видалення
        function openDeleteModal(productId) {
            productToDelete = productId;
            document.getElementById('delete-modal').classList.add('active');
        }

        // Закриття модалки видалення
        function closeDeleteModal() {
            productToDelete = null;
            document.getElementById('delete-modal').classList.remove('active');
        }

        // Підтвердження видалення
        function confirmDelete() {
            if (productToDelete) {
                products = products.filter(p => p.id !== productToDelete);
                localStorage.setItem('adminProducts', JSON.stringify(products));
                
                syncWithMainSite();
                
                loadProducts();
                updateProductsCount();
                closeDeleteModal();
                alert('Товар успішно видалено!');
            }
        }

        // Експорт товарів
        function exportProducts() {
            if (products.length === 0) {
                alert('Немає товарів для експорту!');
                return;
            }
            
            const dataStr = JSON.stringify(products, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `istore-products-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // АВТОМАТИЧНА СИНХРОНІЗАЦІЯ
        function syncWithMainSite() {
            // Зберігаємо для основного сайту
            localStorage.setItem('storeProducts', JSON.stringify(products));
            localStorage.setItem('productsLastUpdate', Date.now().toString());
            
            // Відправляємо сповіщення через Broadcast Channel
            broadcastChannel.postMessage({
                type: 'products_updated',
                timestamp: Date.now(),
                count: products.length
            });
            
            // Спроба оновити відкриті вкладки основного сайту
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage({
                        type: 'products_updated',
                        timestamp: Date.now()
                    }, '*');
                } catch (e) {
                    console.log('Не вдалось оновити основну вкладку');
                }
            }
            
            alert('✅ Товари синхронізовані! Всі користувачі побачать оновлення.');
        }

        // Автоматична синхронізація при завантаженні
        function autoSyncOnLoad() {
            const adminProducts = JSON.parse(localStorage.getItem('adminProducts')) || [];
            const storeProducts = JSON.parse(localStorage.getItem('storeProducts')) || [];
            
            if (adminProducts.length > 0 && storeProducts.length === 0) {
                syncWithMainSite();
            }
        }

        // Припиняємо опитування при закритті сторінки
        window.addEventListener('beforeunload', function() {
            if (supportChatInterval) {
                clearInterval(supportChatInterval);
            }
        });
    </script>
</body>
</html>